<?xml version="1.0" encoding="utf-8" ?>

<SmartSqlMap Scope="User" xmlns="http://SmartSql.net/schemas/SmartSqlMap.xsd">
  <ResultMaps>
    <ResultMap Id="UserResultMap">
      <Result Column="USER_ID" Property="UserId" />
      <Result Column="USER_ACCOUNT" Property="UserAccount" />
      <Result Column="EMPLOYEE_NAME" Property="EmployeeName" />
      <Result Column="USER_ACTIVE_YN" Property="UserActiveYn" />
      <Result Column="ROLES_STRING" Property="RolesString" />
    </ResultMap>

    <ResultMap Id="LoginResultMap">
      <Result Column="USER_ID" Property="UserId" />
      <Result Column="USER_ACCOUNT" Property="UserAccount" />
      <Result Column="USER_PASSWORD" Property="UserPassword" />
      <Result Column="USER_ACTIVE_YN" Property="UserActiveYn" />
    </ResultMap>

    <ResultMap Id="UserPasswordResultMap">
      <Result Column="USER_PASSWORD" Property="UserPassword" />
    </ResultMap>
  </ResultMaps>

  <Statements>

    <!-- 사용자 목록을 조회한다. -->
    <Statement Id="ListUser" ResultMap="UserResultMap">
      /* User.ListUser */

      SELECT
        U.USER_ID,
        U.USER_ACCOUNT,
        E.EMPLOYEE_NAME,
        U.USER_ACTIVE_YN,
        (
          SELECT GROUP_CONCAT(R.ROLE_NAME ORDER BY R.ROLE_ORDER SEPARATOR ', ')
          FROM CO_USER_ROLE UR
          INNER JOIN CO_ROLE R ON R.ROLE_ID = UR.ROLE_ID
          WHERE UR.USER_ID = U.USER_ID
        ) AS ROLES_STRING
      FROM CO_USER U
      INNER JOIN HM_EMPLOYEE E ON E.USER_ID = U.USER_ID
      WHERE U.DELETE_YN = 'N'
    </Statement>

    <!-- 사용자를 조회한다. -->
    <Statement Id="GetUser" ResultMap="UserResultMap">
      /* User.GetUser */

      SELECT
        USER_ID,
        USER_ACCOUNT,
        USER_ACTIVE_YN
      FROM CO_USER
      WHERE 1=1
        AND DELETE_YN = 'N'
        <IsNotEmpty Property="UserId">
        AND USER_ID = @UserId
        </IsNotEmpty>
        <IsNotEmpty Property="UserAccount">
        AND USER_ACCOUNT = @UserAccount
        </IsNotEmpty>
    </Statement>

    <!-- 사용자를 조회한다(로그인용). -->
    <Statement Id="GetUserLogin" ResultMap="LoginResultMap">
      /* User.GetUserLogin */

      SELECT
        USER_ID,
        USER_ACCOUNT,
        USER_PASSWORD,
        USER_ACTIVE_YN
      FROM CO_USER
      WHERE DELETE_YN = 'N'
        AND USER_ACCOUNT = @UserAccount
    </Statement>

    <!-- 사용자 비밀번호를 조회한다. -->
    <Statement Id="GetUserPassword" ResultMap="UserPasswordResultMap">
      /* User.GetUserPassword */

      SELECT
        USER_PASSWORD
      FROM CO_USER
      WHERE DELETE_YN = 'N'
        AND USER_ID = @UserId
    </Statement>

    <!-- 사용자를 추가한다. -->
    <Statement Id="AddUser">
      /* User.AddUser */

      INSERT INTO CO_USER (USER_ACCOUNT, USER_PASSWORD, USER_ACTIVE_YN, CREATER_ID)
      VALUES (@UserAccount, @UserPassword, @UserActiveYn, @CreaterId)
      ;SELECT LAST_INSERT_ID()
    </Statement>

    <!-- 사용자를 수정한다. -->
    <Statement Id="UpdateUser">
      /* User.UpdateUser */

      UPDATE CO_USER
        SET
          <IsNotEmpty Property="UserActiveYn">
          USER_ACTIVE_YN = @UserActiveYn,
          </IsNotEmpty>
          UPDATER_ID = @UpdaterId,
          UPDATE_DT = CURRENT_TIMESTAMP()
      WHERE USER_ID = @UserId
    </Statement>

    <!-- 사용자 비밀번호를 변경한다. -->
    <Statement Id="UpdateUserPassword">
      /* User.UpdateUserPassword */

      UPDATE CO_USER
        SET
          USER_PASSWORD = @NewPassword,
          UPDATER_ID = @UpdaterId,
          UPDATE_DT = CURRENT_TIMESTAMP()
      WHERE USER_ID = @UserId
    </Statement>

    <!-- 사용자를 삭제한다. -->
    <Statement Id="RemoveUser">
      /* User.RemoveUser */

      UPDATE CO_USER
        SET
          DELETE_YN = 'Y',
          UPDATER_ID = @UpdaterId,
          UPDATE_DT = CURRENT_TIMESTAMP()
      WHERE USER_ID = @UserId
    </Statement>
    
  </Statements>
</SmartSqlMap>