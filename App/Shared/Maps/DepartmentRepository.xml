<?xml version="1.0" encoding="utf-8" ?>

<SmartSqlMap Scope="DepartmentRepository" xmlns="http://SmartSql.net/schemas/SmartSqlMap.xsd">
  <ResultMaps>
    <ResultMap Id="DepartmentResultMap">
      <Result Column="DEPARTMENT_ID" Property="DepartmentId" />
      <Result Column="COMPANY_ID" Property="CompanyId" />
      <Result Column="COMPANY_NAME" Property="CompanyName" />
      <Result Column="UP_DEPARTMENT_ID" Property="UpDepartmentId" />
      <Result Column="DEPARTMENT_NAME" Property="DepartmentName" />
      <Result Column="DEPARTMENT_ORDER" Property="DepartmentOrder" />
      <Result Column="RANK_CODE" Property="RankCode" />
      <Result Column="JOB_TITLE_CODE" Property="JobTitleCode" />
      <Result Column="DELETE_YN" Property="DeleteYn" />
    </ResultMap>
  </ResultMaps>

  <Statements>

    <!-- 부서 목록을 조회한다. -->
    <Statement Id="ListDepartment" ResultMap="DepartmentResultMap">
      /* Department.ListDepartment */

      WITH RECURSIVE R AS (
        SELECT
          D.DEPARTMENT_ID,
          D.COMPANY_ID,
          D.UP_DEPARTMENT_ID,
          D.DEPARTMENT_NAME,
          D.DEPARTMENT_ORDER,
          CAST(D.DEPARTMENT_ORDER AS CHAR(200)) AS SORT_ORDER,
          D.DELETE_YN
        FROM HM_DEPARTMENT D
        WHERE D.DEPARTMENT_ID = @DepartmentId
        UNION ALL
        SELECT
          D.DEPARTMENT_ID,
          D.COMPANY_ID,
          D.UP_DEPARTMENT_ID,
          D.DEPARTMENT_NAME,
          D.DEPARTMENT_ORDER,
          CONCAT(R.SORT_ORDER, '-', LPAD(D.DEPARTMENT_ORDER, 5, '0')) AS SORT_ORDER,
          D.DELETE_YN
        FROM HM_DEPARTMENT D
        INNER JOIN R ON R.UP_DEPARTMENT_ID = D.DEPARTMENT_ID
      )
      SELECT
        R.DEPARTMENT_ID,
        R.COMPANY_ID,
        R.UP_DEPARTMENT_ID,
        R.DEPARTMENT_NAME,
        R.DEPARTMENT_ORDER,
        R.DELETE_YN,
        CD.CODE_VALUE AS RANK_CODE,
        CD2.CODE_VALUE AS JOB_TITLE_CODE
      FROM R
      INNER JOIN HM_EMPLOYEE E ON E.COMPANY_ID = R.COMPANY_ID
      INNER JOIN HM_EMPLOYEE_COMPANY EC ON EC.COMPANY_ID = R.COMPANY_ID AND EC.EMPLOYEE_ID = E.EMPLOYEE_ID
      INNER JOIN CO_CODE CD ON CD.CODE_VALUE = EC.RANK_CODE AND CD.UP_CODE_ID = 'RANK_00'
      INNER JOIN CO_CODE CD2 ON CD2.CODE_VALUE = EC.JOB_TITLE_CODE AND CD2.UP_CODE_ID = 'JOB_TITLE_00'
      WHERE R.DELETE_YN = @DeleteYn
        <IsNotEmpty Property="EmployeeId">
        AND E.EMPLOYEE_ID = @EmployeeId
        </IsNotEmpty>
      ORDER BY R.SORT_ORDER DESC
    </Statement>

    <!-- 회사별 부서 목록을 조회한다. -->
    <Statement Id="ListDepartmentByCompany" ResultMap="DepartmentResultMap">
      /* Department.ListDepartmentByCompany */

      WITH RECURSIVE R AS (
        SELECT
          D.DEPARTMENT_ID,
          D.COMPANY_ID,
          C.COMPANY_NAME,
          D.UP_DEPARTMENT_ID,
          D.DEPARTMENT_NAME,
          D.DEPARTMENT_ORDER,
          CAST(D.DEPARTMENT_ORDER AS CHAR(200)) AS SORT_ORDER,
          D.DELETE_YN
        FROM HM_DEPARTMENT D, HM_COMPANY C
        WHERE D.COMPANY_ID = C.COMPANY_ID
          AND D.UP_DEPARTMENT_ID IS NULL
          <IsNotEmpty Property="CompanyId">
          AND D.COMPANY_ID = @CompanyId
          </IsNotEmpty>
        UNION ALL
        SELECT
          D.DEPARTMENT_ID,
          D.COMPANY_ID,
          C.COMPANY_NAME,
          D.UP_DEPARTMENT_ID,
          D.DEPARTMENT_NAME,
          D.DEPARTMENT_ORDER,
          CONCAT(R.SORT_ORDER, '-', LPAD(D.DEPARTMENT_ORDER, 5, '0')) AS SORT_ORDER,
          D.DELETE_YN
        FROM HM_DEPARTMENT D
        INNER JOIN HM_COMPANY C ON C.COMPANY_ID = D.COMPANY_ID
        INNER JOIN R ON D.UP_DEPARTMENT_ID = R.DEPARTMENT_ID
    )
    SELECT
      R.DEPARTMENT_ID,
      R.COMPANY_ID,
      R.COMPANY_NAME,
      R.UP_DEPARTMENT_ID,
      R.DEPARTMENT_NAME,
      R.DEPARTMENT_ORDER,
      R.DELETE_YN
    FROM R
    WHERE R.DELETE_YN = 'N'
    ORDER BY
      CAST(SUBSTRING_INDEX(R.SORT_ORDER, '-', 1) AS UNSIGNED),
      CASE
        WHEN R.SORT_ORDER LIKE '%-%' THEN CAST(SUBSTRING_INDEX(R.SORT_ORDER, '-', -1) AS UNSIGNED)
        ELSE 0
      END
    </Statement>
    
  </Statements>
</SmartSqlMap>